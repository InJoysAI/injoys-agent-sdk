# é«˜å¯ç”¨ä¸ç¾éš¾æ¢å¤æ¨¡æ¿ (HA and DR Template)

> **Metadata**
> - **Source**: `{{æ•°æ®åº“è®¾è®¡æ–‡æ¡£è·¯å¾„}}`
> - **Generated At**: `{{ç”Ÿæˆæ—¶é—´ YYYY-MM-DD HH:mm}}`
> - **Generator**: `Context-Agent v1.0`

---

## ğŸ—ï¸ é«˜å¯ç”¨æ¶æ„

### Patroni é›†ç¾¤

> Patroni + DCS (Etcd/Consul) æ˜¯ PostgreSQL HA çš„ç°ä»£æ ‡å‡†ã€‚

```mermaid
graph TB
    subgraph "DCS (Etcd)"
        ETCD[Leader Key]
    end

    subgraph "PostgreSQL Cluster"
        PRIMARY[Primary Node]
        REPLICA1[Replica 1]
        REPLICA2[Replica 2]
    end

    subgraph "Load Balancer"
        HAPROXY[HAProxy]
    end

    APP[Application] --> HAPROXY
    HAPROXY --> PRIMARY
    HAPROXY -.-> REPLICA1
    HAPROXY -.-> REPLICA2

    PRIMARY --> ETCD
    REPLICA1 --> ETCD
    REPLICA2 --> ETCD
```

### å…³é”®æœºåˆ¶

| æœºåˆ¶ | è¯´æ˜ |
|------|------|
| **Leader é€‰ä¸¾** | é€šè¿‡ DCS ç«äº‰ Leader Key |
| **ç§Ÿçº¦ (TTL)** | Leader å®šæœŸæ›´æ–°ï¼Œè¿‡æœŸè§¦å‘é€‰ä¸¾ |
| **Fencing** | å¤±å»ç§Ÿçº¦ç«‹å³é™çº§ä¸ºåªè¯» |

### æµé‡è·¯ç”±

| ç»„ä»¶ | é…ç½® |
|------|------|
| **HAProxy** | å¥åº·æ£€æŸ¥ Patroni REST API `/primary` |
| **ä¸»èŠ‚ç‚¹** | è¿”å› HTTP 200 |
| **ä»èŠ‚ç‚¹** | è¿”å› HTTP 503 |

---

## ğŸ”„ å¤åˆ¶æ¨¡å¼

| æ¨¡å¼ | RPO | å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|------|-----|------|---------|
| **å¼‚æ­¥** | > 0 | æœ€ä½ | ä¸€èˆ¬ä¸šåŠ¡ |
| **åŒæ­¥** | = 0 | æœ€é«˜ | é‡‘è/æ ¸å¿ƒäº¤æ˜“ |
| **remote_write** | â‰ˆ 0 | ä¸­ç­‰ | **æ¨èæŠ˜ä¸­æ–¹æ¡ˆ** |

### é…ç½®ç¤ºä¾‹

```ini
# æŠ˜ä¸­æ–¹æ¡ˆï¼šç­‰å¾…ä»åº“ç¡®è®¤æ”¶åˆ°ï¼ˆå†™å…¥ OS ç¼“å­˜ï¼‰
synchronous_commit = remote_write
synchronous_standby_names = 'replica1'
```

---

## ğŸ’¾ å¤‡ä»½ç­–ç•¥

### pgBackRest é…ç½®

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **å¹¶è¡Œå¤„ç†** | å‹ç¼©/åŠ å¯†/ä¼ è¾“å¹¶è¡ŒåŒ– |
| **å¢é‡æ¢å¤** | Delta Restore ä»…æ¢å¤å˜åŒ–æ•°æ® |
| **S3 åŸç”Ÿæ”¯æŒ** | ç›´æ¥å¯¹æ¥å¯¹è±¡å­˜å‚¨ |

### å¤‡ä»½å‘¨æœŸ

| ç±»å‹ | é¢‘ç‡ | ä¿ç•™æœŸ |
|------|------|--------|
| **å…¨é‡å¤‡ä»½** | æ¯å‘¨ï¼ˆå‘¨æ—¥ï¼‰ | 8 å‘¨ |
| **å¢é‡å¤‡ä»½** | æ¯å¤© | 14 å¤© |
| **WAL å½’æ¡£** | å®æ—¶ | 14 å¤© |

### é…ç½®ç¤ºä¾‹

```ini
# pgbackrest.conf
[global]
repo1-type=s3
repo1-s3-bucket=db-backups
repo1-s3-region=ap-northeast-1
repo1-retention-full=8
repo1-retention-diff=14
compress-type=zst
compress-level=3

[main]
pg1-path=/var/lib/postgresql/data
```

---

## â±ï¸ PITR (æ—¶é—´ç‚¹æ¢å¤)

### æ¢å¤æµç¨‹

```mermaid
sequenceDiagram
    participant Admin
    participant pgBackRest
    participant PostgreSQL

    Admin->>pgBackRest: 1. åœæ­¢å½“å‰å®ä¾‹
    Admin->>pgBackRest: 2. restore --target-time="2024-01-15 09:59:00"
    pgBackRest->>PostgreSQL: 3. æ¢å¤åŸºç¡€å¤‡ä»½
    pgBackRest->>PostgreSQL: 4. é‡æ”¾ WAL è‡³ç›®æ ‡æ—¶é—´
    Admin->>PostgreSQL: 5. å¯åŠ¨å®ä¾‹
```

### æ¢å¤å‘½ä»¤

```bash
# åœæ­¢ PostgreSQL
sudo systemctl stop postgresql

# æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹
pgbackrest restore \
    --stanza=main \
    --type=time \
    --target="2024-01-15 09:59:00+08" \
    --target-action=promote

# å¯åŠ¨ PostgreSQL
sudo systemctl start postgresql
```

---

## ğŸ”’ é˜²å‹’ç´¢ï¼šä¸å¯å˜å¤‡ä»½

### S3 Object Lock

> åˆè§„æ¨¡å¼ä¸‹ï¼Œä»»ä½•äººï¼ˆåŒ…æ‹¬ Rootï¼‰éƒ½æ— æ³•åˆ é™¤å¤‡ä»½ã€‚

```ini
# pgbackrest.conf
repo1-s3-bucket-object-lock=true
repo1-retention-full-type=time
repo1-retention-full=30  # 30 å¤©ä¸å¯å˜
```

### é…ç½®è¦ç‚¹

| é…ç½® | è¯´æ˜ |
|------|------|
| **Object Lock Mode** | Complianceï¼ˆåˆè§„æ¨¡å¼ï¼‰ |
| **Retention Period** | æœ€å°‘ 30 å¤© |
| **Versioning** | å¿…é¡»å¯ç”¨ |

---

## ğŸ¯ RTO/RPO ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®ç°æ–¹å¼ |
|------|------|---------|
| **RPO** | < 1 åˆ†é’Ÿ | å®æ—¶ WAL å½’æ¡£ + synchronous_commit |
| **RTO** | < 15 åˆ†é’Ÿ | pgBackRest Delta Restore |

### æ¢å¤æ¼”ç»ƒ

| æ¼”ç»ƒç±»å‹ | é¢‘ç‡ | å†…å®¹ |
|---------|------|------|
| å¤‡ä»½éªŒè¯ | æ¯å‘¨ | è‡ªåŠ¨æ¢å¤æµ‹è¯• + æ ¡éªŒ |
| æ•…éšœè½¬ç§» | æ¯å­£åº¦ | Patroni æ‰‹åŠ¨åˆ‡æ¢æ¼”ç»ƒ |
| å…¨é‡æ¢å¤ | æ¯åŠå¹´ | å®Œæ•´ PITR æµç¨‹ |

---

## AI å¼•ç”¨æŒ‡å—

å½“ AI è®¾è®¡æ•°æ®åº“ HA/DR æ—¶ï¼š
1. ä½¿ç”¨ Patroni + DCS å®ç° HA
2. é…ç½® pgBackRest å®ç°å¤‡ä»½
3. å¯ç”¨ S3 Object Lock é˜²å‹’ç´¢
4. å®šæœŸè¿›è¡Œæ¢å¤æ¼”ç»ƒ
