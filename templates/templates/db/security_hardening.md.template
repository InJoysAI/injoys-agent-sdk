# PostgreSQL å®‰å…¨åŠ å›ºæ¨¡æ¿ (Security Hardening Template)

> **Metadata**
> - **Source**: `{{æ•°æ®åº“è®¾è®¡æ–‡æ¡£è·¯å¾„}}`
> - **Generated At**: `{{ç”Ÿæˆæ—¶é—´ YYYY-MM-DD HH:mm}}`
> - **Generator**: `Context-Agent v1.0`

---

> **âš ï¸ æƒå¨è¯´æ˜**  
> æœ¬æ–‡ä»¶ä¸º **DB è§†è§’**å®‰å…¨çº¦æŸã€‚æœ€ç»ˆæƒå¨å½’æ¡£äº `architecture/security_policy.md`ã€‚

---

## ğŸ” è®¤è¯åŠ å›º

### åºŸå¼ƒ MD5ï¼Œå¼ºåˆ¶ SCRAM-SHA-256

```ini
# postgresql.conf
password_encryption = scram-sha-256
```

```bash
# æ›´æ–°ç°æœ‰ç”¨æˆ·å¯†ç ï¼ˆä½¿ç”¨æ–°åŠ å¯†ï¼‰
ALTER USER app_user SET password_encryption = 'scram-sha-256';
ALTER USER app_user PASSWORD 'new_secure_password';
```

### è®¤è¯æ–¹å¼æ¯”è¾ƒ

| æ–¹å¼ | å®‰å…¨çº§åˆ« | è¯´æ˜ |
|------|---------|------|
| `trust` | âŒ ç¦æ­¢ | æ— å¯†ç ï¼Œä»…é™æœ¬åœ°è°ƒè¯• |
| `md5` | âŒ åºŸå¼ƒ | æ˜“å—é‡æ”¾æ”»å‡» |
| `scram-sha-256` | âœ… æ¨è | ç°ä»£æ ‡å‡† |
| `cert` | âœ…âœ… æœ€ä½³ | mTLS å®¢æˆ·ç«¯è¯ä¹¦ |

---

## ğŸ“‹ pg_hba.conf è§„èŒƒ

### ç”Ÿäº§ç¯å¢ƒé…ç½®åŸåˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **ç™½åå•ä¼˜å…ˆ** | ä»…å…è®¸å·²çŸ¥åº”ç”¨æœåŠ¡å™¨ IP |
| **ç¦æ­¢ trust** | ä»»ä½•ç¯å¢ƒéƒ½ä¸ä½¿ç”¨ |
| **å¼ºåˆ¶ hostssl** | ç¦æ­¢éåŠ å¯†è¿æ¥ |
| **æŒ‰è§’è‰²åˆ†ç¦»** | ä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒç”¨æˆ· |

### é…ç½®ç¤ºä¾‹

```
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
local   all             postgres                                scram-sha-256

# åº”ç”¨æœåŠ¡å™¨ï¼ˆä¸¥æ ¼ç™½åå•ï¼‰
hostssl app_db          app_user        10.0.1.0/24             scram-sha-256
hostssl app_db          app_user        10.0.2.0/24             scram-sha-256

# ç›‘æ§ç³»ç»Ÿï¼ˆåªè¯»è´¦æˆ·ï¼‰
hostssl all             monitor_user    10.0.10.5/32            scram-sha-256

# ç¦æ­¢å…¶ä»–æ‰€æœ‰è¿æ¥
hostssl all             all             0.0.0.0/0               reject
```

---

## ğŸ”’ TLS é…ç½®

### æœåŠ¡ç«¯é…ç½®

```ini
# postgresql.conf
ssl = on
ssl_cert_file = '/path/to/server.crt'
ssl_key_file = '/path/to/server.key'
ssl_ca_file = '/path/to/ca.crt'

# æœ€ä½åè®®ç‰ˆæœ¬
ssl_min_protocol_version = 'TLSv1.2'

# æ¨èå¯†ç å¥—ä»¶
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
```

### mTLSï¼ˆåŒå‘è®¤è¯ï¼‰

```
# pg_hba.conf - è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦
hostssl all             all             0.0.0.0/0               cert clientcert=verify-ca
```

| æ¨¡å¼ | è¯´æ˜ |
|------|------|
| `clientcert=verify-ca` | éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ç”±æŒ‡å®š CA ç­¾å‘ |
| `clientcert=verify-full` | é¢å¤–éªŒè¯ CN ä¸ç”¨æˆ·ååŒ¹é… |

---

## ğŸ‘¤ æœ€å°æƒé™åŸåˆ™

### è§’è‰²åˆ†ç¦»

| è§’è‰² | æƒé™ | ç”¨é€” |
|------|------|------|
| `app_user` | ä»… CONNECT + è¡¨ CRUD | åº”ç”¨ç¨‹åº |
| `migration_user` | ä¸´æ—¶ DDL æƒé™ | CI/CD è¿ç§» |
| `monitor_user` | pg_monitor | ç›‘æ§ç³»ç»Ÿ |
| `backup_user` | pg_read_all_data | å¤‡ä»½ä»»åŠ¡ |
| `postgres` | SUPERUSER | ç´§æ€¥è¿ç»´ |

### æˆæƒç¤ºä¾‹

```sql
-- åº”ç”¨ç”¨æˆ·ï¼šä»…è¡¨çº§ CRUD
GRANT CONNECT ON DATABASE app_db TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public 
  GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;

-- ç¦æ­¢ TRUNCATE å’Œ DDL
REVOKE TRUNCATE ON ALL TABLES IN SCHEMA public FROM app_user;

-- ç›‘æ§ç”¨æˆ·ï¼šåªè¯»ç³»ç»Ÿè§†å›¾
GRANT pg_monitor TO monitor_user;
```

---

## ğŸ” æ•æ„Ÿæ•°æ®å¤„ç†

### å­—æ®µçº§åŠ å¯†ï¼ˆåº”ç”¨å±‚ï¼‰

| æ•°æ®ç±»å‹ | åŠ å¯†æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| å¯†ç å“ˆå¸Œ | bcrypt/argon2 | ä¸å¯é€† |
| ä¿¡ç”¨å¡å· | AES-256-GCM | åº”ç”¨å±‚åŠ å¯† |
| ä¸ªäººèº«ä»½ä¿¡æ¯ | AES-256-GCM | æŒ‰éœ€è„±æ• |

### æ•°æ®è„±æ•è§†å›¾

```sql
-- åˆ›å»ºè„±æ•è§†å›¾ä¾›åˆ†æ/å®¢æœä½¿ç”¨
CREATE VIEW users_masked AS
SELECT 
    id,
    CONCAT(LEFT(email, 3), '***@***') AS email_masked,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) AS phone_masked,
    created_at
FROM users;

GRANT SELECT ON users_masked TO analyst_user;
```

---

## ğŸ“Š å®‰å…¨å®¡è®¡

### å¼€å¯æ—¥å¿—

```ini
# postgresql.conf
log_connections = on
log_disconnections = on
log_statement = 'ddl'  # è®°å½•æ‰€æœ‰ DDL
log_line_prefix = '%m [%p] %u@%d '
```

### pgAudit æ‰©å±•ï¼ˆé«˜åˆè§„éœ€æ±‚ï¼‰

```sql
-- å®‰è£… pgAudit
CREATE EXTENSION pgaudit;

-- é…ç½®å®¡è®¡
ALTER SYSTEM SET pgaudit.log = 'write, ddl';
ALTER SYSTEM SET pgaudit.log_catalog = off;
```

---

## AI å¼•ç”¨æŒ‡å—

å½“ AI ç”Ÿæˆæ•°æ®åº“å®‰å…¨é…ç½®æ—¶ï¼š
1. è®¤è¯å¿…é¡»ä½¿ç”¨ SCRAM-SHA-256
2. pg_hba.conf ä¸¥æ ¼ç™½åå•
3. å¼ºåˆ¶ TLS åŠ å¯†
4. éµå¾ªæœ€å°æƒé™åŸåˆ™
