# è¿ç§»ä¸ SSoT çº¦æŸæ¨¡æ¿ (Migrations and SSoT Template)

> **Metadata**
> - **Source**: `{{æ•°æ®åº“è®¾è®¡æ–‡æ¡£è·¯å¾„}}`
> - **Generated At**: `{{ç”Ÿæˆæ—¶é—´ YYYY-MM-DD HH:mm}}`
> - **Generator**: `Context-Agent v1.0`

---

## ğŸ¯ SSoT åŸåˆ™

> **Single Source of Truth**: `schema/postgres.hcl` æ˜¯æ•°æ®åº“ Schema çš„å”¯ä¸€çœŸç›¸æºã€‚

### ç¦æ­¢è¡Œä¸º

| âŒ ç¦æ­¢ | âœ… æ­£ç¡®åšæ³• |
|--------|-----------|
| ç›´æ¥ç¼–å†™ `.sql` è¿ç§»æ–‡ä»¶ | ä¿®æ”¹ `schema/postgres.hcl` â†’ Atlas ç”Ÿæˆè¿ç§» |
| åœ¨ç”Ÿäº§åº“æ‰‹åŠ¨æ‰§è¡Œ DDL | é€šè¿‡ CI/CD Pipeline æ‰§è¡Œ `atlas migrate apply` |
| å¤šäººåŒæ—¶ä¿®æ”¹ Schema | PR Review åˆå¹¶ HCL å˜æ›´ |

---

## ğŸ”§ Atlas å·¥ä½œæµ

### æ ‡å‡†æµç¨‹

```mermaid
flowchart LR
    A[ä¿®æ”¹ schema/postgres.hcl] --> B[atlas migrate diff]
    B --> C[Review è¿ç§» SQL]
    C --> D[PR åˆå¹¶]
    D --> E[CI: atlas migrate apply]
    E --> F[éªŒè¯ Schema]
```

### å¸¸ç”¨å‘½ä»¤

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
atlas migrate diff migration_name \
  --dir "file://schema/migrations" \
  --to "file://schema/postgres.hcl" \
  --dev-url "docker://postgres/15"

# åº”ç”¨è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
atlas migrate apply \
  --dir "file://schema/migrations" \
  --url "postgres://user:pass@localhost:5432/dev?sslmode=disable"

# éªŒè¯ Schema çŠ¶æ€
atlas migrate status \
  --dir "file://schema/migrations" \
  --url "postgres://..."

# æ ¡éªŒè¿ç§»æ–‡ä»¶å®Œæ•´æ€§
atlas migrate validate \
  --dir "file://schema/migrations" \
  --dev-url "docker://postgres/15"
```

---

## ğŸ”„ é›¶åœæœºè¿ç§»ç­–ç•¥

### Expand-Contract æ¨¡å¼

| é˜¶æ®µ | æ“ä½œ | ç›®çš„ |
|------|------|------|
| **Expand** | æ·»åŠ æ–°åˆ—/è¡¨ï¼ˆå¯ç©ºæˆ–æœ‰é»˜è®¤å€¼ï¼‰ | æ–°æ—§ä»£ç å…¼å®¹ |
| **Migrate** | åå°æ•°æ®è¿ç§» | å¡«å……æ–°å­—æ®µ |
| **Switch** | åº”ç”¨ä»£ç åˆ‡æ¢åˆ°æ–°å­—æ®µ | è¯»å†™æ–°å­—æ®µ |
| **Contract** | åˆ é™¤æ—§åˆ—/è¡¨ | æ¸…ç† |

### ç¤ºä¾‹ï¼šé‡å‘½ååˆ—

```sql
-- âŒ é”™è¯¯ï¼šç›´æ¥é‡å‘½åä¼šå¯¼è‡´å®•æœº
ALTER TABLE users RENAME COLUMN name TO full_name;

-- âœ… æ­£ç¡®ï¼šåˆ†é˜¶æ®µ
-- Phase 1: Expand
ALTER TABLE users ADD COLUMN full_name TEXT;
UPDATE users SET full_name = name WHERE full_name IS NULL;

-- Phase 2: Switch (åº”ç”¨ä»£ç æ›´æ–°å)
-- Phase 3: Contract
ALTER TABLE users DROP COLUMN name;
```

---

## âœ… å‘åå…¼å®¹å˜æ›´ï¼ˆSafeï¼‰

| å˜æ›´ç±»å‹ | å®‰å…¨æ€§ | è¯´æ˜ |
|---------|--------|------|
| æ·»åŠ å¯ç©ºåˆ— | âœ… Safe | ä¸å½±å“ç°æœ‰æ•°æ® |
| æ·»åŠ æœ‰é»˜è®¤å€¼çš„åˆ— | âœ… Safe | éœ€æ³¨æ„å¤§è¡¨æ€§èƒ½ |
| æ·»åŠ æ–°è¡¨ | âœ… Safe | æ— å½±å“ |
| æ·»åŠ ç´¢å¼• (CONCURRENTLY) | âœ… Safe | ä¸é˜»å¡è¯»å†™ |
| æ·»åŠ å¤–é”®çº¦æŸ | âš ï¸ Caution | éœ€ NOT VALID + VALIDATE |

---

## âŒ ç”Ÿäº§ç¯å¢ƒç¦æ­¢æ“ä½œ

| æ“ä½œ | é£é™© | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|---------|
| `DROP TABLE` / `DROP COLUMN` | æ•°æ®ä¸¢å¤± | å…ˆé‡å‘½å + ä¿ç•™ 30 å¤© |
| `ALTER TABLE ... RENAME` | åº”ç”¨ä¸­æ–­ | Expand-Contract |
| `CREATE INDEX` (é CONCURRENTLY) | é”è¡¨ | `CREATE INDEX CONCURRENTLY` |
| ä¿®æ”¹åˆ—ç±»å‹ | å…¨è¡¨é” | æ·»åŠ æ–°åˆ— + æ•°æ®è¿ç§» |
| `TRUNCATE` | æ•°æ®ä¸¢å¤± | ç¦æ­¢ï¼Œä½¿ç”¨ DELETE + VACUUM |

---

## ğŸ“‹ è¿ç§» Checklist

```markdown
## è¿ç§» PR Checklist

- [ ] ä¿®æ”¹äº† `schema/postgres.hcl`ï¼ˆSSoTï¼‰
- [ ] è¿è¡Œ `atlas migrate diff` ç”Ÿæˆè¿ç§»
- [ ] Review è¿ç§» SQL å†…å®¹
- [ ] éªŒè¯å‘åå…¼å®¹æ€§
- [ ] å¤§è¡¨å˜æ›´ä½¿ç”¨ CONCURRENTLY
- [ ] å›æ»šè„šæœ¬å‡†å¤‡ï¼ˆå¦‚éœ€ï¼‰
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
```

---

## AI å¼•ç”¨æŒ‡å—

å½“ AI ç”Ÿæˆæ•°æ®åº“å˜æ›´æ—¶ï¼š
1. **ç¦æ­¢ç›´æ¥è¾“å‡º SQL** â€” å¿…é¡»ä¿®æ”¹ `schema/postgres.hcl`
2. éµå¾ª Expand-Contract æ¨¡å¼
3. ç´¢å¼•å˜æ›´ä½¿ç”¨ CONCURRENTLY
4. ä¸å®‰å…¨æ“ä½œéœ€åˆ†é˜¶æ®µæˆ–äººå·¥ç¡®è®¤
