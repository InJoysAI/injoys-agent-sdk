# è¿ç§»ä¸ SSoT çº¦æŸæ¨¡æ¿ (Migrations and SSoT Template)

> **Metadata**
> - **Source**: `{{æ•°æ®åº“è®¾è®¡æ–‡æ¡£è·¯å¾„}}`
> - **Generated At**: `{{ç”Ÿæˆæ—¶é—´ YYYY-MM-DD HH:mm}}`
> - **Generator**: `Context-Agent v1.0`

---

## ğŸ¯ SSoT åŸåˆ™

> **Single Source of Truth**: `SSoT/schema/migrations/` æ˜¯æ•°æ®åº“ Schema çš„å”¯ä¸€çœŸç›¸æºã€‚

### ç¦æ­¢è¡Œä¸º

| âŒ ç¦æ­¢ | âœ… æ­£ç¡®åšæ³• |
|--------|-----------| 
| ç›´æ¥åœ¨æ•°æ®åº“æ‰§è¡Œ DDL | åˆ›å»º Goose SQL è¿ç§»æ–‡ä»¶ |
| åœ¨ç”Ÿäº§åº“æ‰‹åŠ¨æ‰§è¡Œ DDL | é€šè¿‡ CI/CD Pipeline æ‰§è¡Œ `goose up` |
| å¤šäººåŒæ—¶ä¿®æ”¹ Schema | PR Review åˆå¹¶è¿ç§»æ–‡ä»¶ |

---

## ğŸ”§ Goose å·¥ä½œæµ

### æ ‡å‡†æµç¨‹

```mermaid
flowchart LR
    A[åˆ›å»ºè¿ç§»æ–‡ä»¶] --> B[goose create]
    B --> C[ç¼–å†™ SQL]
    C --> D[Review è¿ç§» SQL]
    D --> E[PR åˆå¹¶]
    E --> F[CI: goose up]
    F --> G[éªŒè¯ Schema]
```

### å¸¸ç”¨å‘½ä»¤

```bash
# åˆ›å»ºæ–°è¿ç§»æ–‡ä»¶ï¼ˆSQL æ ¼å¼ï¼‰
goose -dir SSoT/schema/migrations create add_users_table sql

# åº”ç”¨è¿ç§»ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
goose -dir SSoT/schema/migrations \
  postgres "postgres://user:pass@localhost:5432/dev?sslmode=disable" up

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
goose -dir SSoT/schema/migrations \
  postgres "postgres://..." status

# å›æ»šæœ€è¿‘ä¸€æ¬¡è¿ç§»
goose -dir SSoT/schema/migrations \
  postgres "postgres://..." down

# ä½¿ç”¨ç¯å¢ƒå˜é‡
export GOOSE_DRIVER=postgres
export GOOSE_DBSTRING="postgres://user:pass@localhost:5432/dev?sslmode=disable"
export GOOSE_MIGRATION_DIR=SSoT/schema/migrations
goose up
```

### è¿ç§»æ–‡ä»¶æ ¼å¼

```sql
-- +goose Up
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- +goose Down
DROP TABLE users;
```

### Go è¿ç§»å‡½æ•°ï¼ˆå¤æ‚é€»è¾‘ï¼‰

å¯¹äºéœ€è¦ç¨‹åºé€»è¾‘çš„å¤æ‚è¿ç§»ï¼Œå¯ä½¿ç”¨ Go è¿ç§»å‡½æ•°ï¼š

```go
// æ–‡ä»¶: SSoT/schema/migrations/00002_seed_data.go
package migrations

import (
    "database/sql"
    "github.com/pressly/goose/v3"
)

func init() {
    goose.AddMigration(Up00002, Down00002)
}

func Up00002(tx *sql.Tx) error {
    // å¤æ‚æ•°æ®è¿ç§»é€»è¾‘
    _, err := tx.Exec(`INSERT INTO users (email) VALUES ('admin@example.com')`)
    return err
}

func Down00002(tx *sql.Tx) error {
    _, err := tx.Exec(`DELETE FROM users WHERE email = 'admin@example.com'`)
    return err
}
```

### åµŒå…¥å¼è‡ªåŠ¨è¿ç§»

åœ¨ Go åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼š

```go
import (
    "embed"
    "github.com/pressly/goose/v3"
)

//go:embed SSoT/schema/migrations/*.sql
var embedMigrations embed.FS

func main() {
    goose.SetBaseFS(embedMigrations)
    if err := goose.Up(db, "SSoT/schema/migrations"); err != nil {
        log.Fatal(err)
    }
}
```

---

## ğŸ”„ é›¶åœæœºè¿ç§»ç­–ç•¥

### Expand-Contract æ¨¡å¼

| é˜¶æ®µ | æ“ä½œ | ç›®çš„ |
|------|------|------|
| **Expand** | æ·»åŠ æ–°åˆ—/è¡¨ï¼ˆå¯ç©ºæˆ–æœ‰é»˜è®¤å€¼ï¼‰ | æ–°æ—§ä»£ç å…¼å®¹ |
| **Migrate** | åå°æ•°æ®è¿ç§» | å¡«å……æ–°å­—æ®µ |
| **Switch** | åº”ç”¨ä»£ç åˆ‡æ¢åˆ°æ–°å­—æ®µ | è¯»å†™æ–°å­—æ®µ |
| **Contract** | åˆ é™¤æ—§åˆ—/è¡¨ | æ¸…ç† |

### ç¤ºä¾‹ï¼šé‡å‘½ååˆ—

```sql
-- âŒ é”™è¯¯ï¼šç›´æ¥é‡å‘½åä¼šå¯¼è‡´å®•æœº
ALTER TABLE users RENAME COLUMN name TO full_name;

-- âœ… æ­£ç¡®ï¼šåˆ†é˜¶æ®µ
-- Phase 1: Expand (00003_add_full_name.sql)
-- +goose Up
ALTER TABLE users ADD COLUMN full_name TEXT;
UPDATE users SET full_name = name WHERE full_name IS NULL;

-- +goose Down
ALTER TABLE users DROP COLUMN full_name;

-- Phase 2: Switch (åº”ç”¨ä»£ç æ›´æ–°å)
-- Phase 3: Contract (00004_drop_name.sql)
-- +goose Up
ALTER TABLE users DROP COLUMN name;

-- +goose Down
ALTER TABLE users ADD COLUMN name TEXT;
```

---

## âœ… å‘åå…¼å®¹å˜æ›´ï¼ˆSafeï¼‰

| å˜æ›´ç±»å‹ | å®‰å…¨æ€§ | è¯´æ˜ |
|---------|--------|------|
| æ·»åŠ å¯ç©ºåˆ— | âœ… Safe | ä¸å½±å“ç°æœ‰æ•°æ® |
| æ·»åŠ æœ‰é»˜è®¤å€¼çš„åˆ— | âœ… Safe | éœ€æ³¨æ„å¤§è¡¨æ€§èƒ½ |
| æ·»åŠ æ–°è¡¨ | âœ… Safe | æ— å½±å“ |
| æ·»åŠ ç´¢å¼• (CONCURRENTLY) | âœ… Safe | ä¸é˜»å¡è¯»å†™ |
| æ·»åŠ å¤–é”®çº¦æŸ | âš ï¸ Caution | éœ€ NOT VALID + VALIDATE |

---

## âŒ ç”Ÿäº§ç¯å¢ƒç¦æ­¢æ“ä½œ

| æ“ä½œ | é£é™© | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|---------| 
| `DROP TABLE` / `DROP COLUMN` | æ•°æ®ä¸¢å¤± | å…ˆé‡å‘½å + ä¿ç•™ 30 å¤© |
| `ALTER TABLE ... RENAME` | åº”ç”¨ä¸­æ–­ | Expand-Contract |
| `CREATE INDEX` (é CONCURRENTLY) | é”è¡¨ | `CREATE INDEX CONCURRENTLY` |
| ä¿®æ”¹åˆ—ç±»å‹ | å…¨è¡¨é” | æ·»åŠ æ–°åˆ— + æ•°æ®è¿ç§» |
| `TRUNCATE` | æ•°æ®ä¸¢å¤± | ç¦æ­¢ï¼Œä½¿ç”¨ DELETE + VACUUM |

---

## ğŸ“‹ è¿ç§» Checklist

```markdown
## è¿ç§» PR Checklist

- [ ] åˆ›å»ºäº† Goose è¿ç§»æ–‡ä»¶ï¼ˆ`SSoT/schema/migrations/`ï¼‰
- [ ] è¿ç§»æ–‡ä»¶åŒ…å« `-- +goose Up` å’Œ `-- +goose Down`
- [ ] Review è¿ç§» SQL å†…å®¹
- [ ] éªŒè¯å‘åå…¼å®¹æ€§
- [ ] å¤§è¡¨å˜æ›´ä½¿ç”¨ CONCURRENTLY
- [ ] å›æ»šè„šæœ¬å‡†å¤‡ï¼ˆDown è¿ç§»ï¼‰
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
```

---

## AI å¼•ç”¨æŒ‡å—

å½“ AI ç”Ÿæˆæ•°æ®åº“å˜æ›´æ—¶ï¼š
1. **ç¦æ­¢ç›´æ¥è¾“å‡º SQL** â€” å¿…é¡»åˆ›å»º Goose è¿ç§»æ–‡ä»¶åˆ° `SSoT/schema/migrations/`
2. éµå¾ª Expand-Contract æ¨¡å¼
3. ç´¢å¼•å˜æ›´ä½¿ç”¨ CONCURRENTLY
4. ä¸å®‰å…¨æ“ä½œéœ€åˆ†é˜¶æ®µæˆ–äººå·¥ç¡®è®¤
