# PostgreSQL å¯è§‚æµ‹æ€§æ¨¡æ¿ (Observability Template)

> **Metadata**
> - **Source**: `{{æ•°æ®åº“è®¾è®¡æ–‡æ¡£è·¯å¾„}}`
> - **Generated At**: `{{ç”Ÿæˆæ—¶é—´ YYYY-MM-DD HH:mm}}`
> - **Generator**: `Context-Agent v1.0`

---

## ğŸ“Š å…³é”®æŒ‡æ ‡ä¸å‘Šè­¦é˜ˆå€¼

| ç»´åº¦ | æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | ä¸šåŠ¡å«ä¹‰ |
|------|------|---------|---------|
| **å¯ç”¨æ€§** | PostgreSQL Up/Down | çŠ¶æ€å˜åŒ– | æ•°æ®åº“å­˜æ´» |
| **å¯ç”¨æ€§** | Patroni Leader å˜æ›´ | ä»»ä½•åˆ‡æ¢ | ä¸»å¤‡åˆ‡æ¢ |
| **æ€§èƒ½** | Active Connections | > 80% max_conn | è¿æ¥æ± å³å°†æ‰“æ»¡ |
| **æ€§èƒ½** | Lock Wait Time | > 5s | é”äº‰ç”¨/æ­»é” |
| **æ€§èƒ½** | Query Latency P99 | > SLA (å¦‚ 100ms) | å“åº”æ—¶é—´åŠ£åŒ– |
| **å¤åˆ¶** | Replication Lag | > 100MB æˆ– > 10s | ä»åº“å»¶è¿Ÿ |
| **é£é™©** | Transaction ID Age | > **15 äº¿** | **æé«˜å±ï¼šéœ€ç«‹å³ Vacuum** |
| **å­˜å‚¨** | Disk Usage | > 85% | ç£ç›˜ç©ºé—´ä¸è¶³ |
| **å­˜å‚¨** | WAL Directory Size | > 10GB | WAL å †ç§¯ |

---

## âš ï¸ Transaction ID å›å·ç›‘æ§

> **æœ€é«˜å±é£é™©**ï¼šPostgreSQL ä½¿ç”¨ 32 ä½äº‹åŠ¡ IDï¼Œä¸Šé™çº¦ 21 äº¿ã€‚è¶…è¿‡ 20 äº¿ï¼ˆå®‰å…¨ä½™é‡ 15 äº¿å‘Šè­¦ï¼‰æ•°æ®åº“å°†**å¼ºåˆ¶åœæœº**æ‹’ç»æ–°äº‹åŠ¡ã€‚

### ç›‘æ§æŸ¥è¯¢

```sql
-- æ£€æŸ¥ XID å¹´é¾„ï¼ˆ> 15 äº¿éœ€ç«‹å³å¤„ç†ï¼‰
SELECT 
    datname,
    age(datfrozenxid) AS xid_age,
    CASE 
        WHEN age(datfrozenxid) > 1500000000 THEN 'ğŸ”´ CRITICAL'
        WHEN age(datfrozenxid) > 1000000000 THEN 'ğŸŸ¡ WARNING'
        ELSE 'ğŸŸ¢ OK'
    END AS status
FROM pg_database
ORDER BY xid_age DESC;

-- éœ€è¦ Vacuum çš„è¡¨
SELECT 
    schemaname,
    relname,
    n_dead_tup,
    last_autovacuum,
    age(relfrozenxid) AS xid_age
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC;
```

### ç´§æ€¥å¤„ç†

```bash
# æ‰‹åŠ¨æ‰§è¡Œ Vacuumï¼ˆç´§æ€¥æƒ…å†µï¼‰
vacuumdb --freeze --all --verbose
```

---

## ğŸ“ˆ pg_stat_statements é…ç½®

### å¯ç”¨æ‰©å±•

```ini
# postgresql.conf
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000
```

```sql
-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

### æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- æ€»è€—æ—¶ Top 10ï¼ˆæœ€é‡è¦ï¼‰
SELECT 
    LEFT(query, 80) AS query_preview,
    calls,
    ROUND(total_exec_time::numeric, 2) AS total_ms,
    ROUND(mean_exec_time::numeric, 2) AS mean_ms,
    ROUND((100 * total_exec_time / SUM(total_exec_time) OVER())::numeric, 2) AS pct
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;

-- é«˜é¢‘æŸ¥è¯¢ Top 10
SELECT 
    LEFT(query, 80) AS query_preview,
    calls,
    ROUND(mean_exec_time::numeric, 2) AS mean_ms
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 10;

-- é‡ç½®ç»Ÿè®¡ï¼ˆå®šæœŸæ¸…ç†ï¼‰
SELECT pg_stat_statements_reset();
```

---

## ğŸ§¹ Vacuum å¥åº·æ£€æŸ¥

### ç›‘æ§æŸ¥è¯¢

```sql
-- Autovacuum æ´»åŠ¨
SELECT 
    schemaname,
    relname,
    n_live_tup,
    n_dead_tup,
    ROUND(100 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_pct,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;

-- å½“å‰ Autovacuum è¿›ç¨‹
SELECT 
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    heap_blks_scanned,
    heap_blks_total
FROM pg_stat_progress_vacuum;
```

### å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡ | é˜ˆå€¼ | å¤„ç† |
|------|------|------|
| Dead Tuple % | > 10% | æ£€æŸ¥ Autovacuum æ˜¯å¦å·¥ä½œ |
| last_autovacuum | > 7 å¤© | æ‰‹åŠ¨è§¦å‘ VACUUM |
| n_dead_tup | > 100 ä¸‡ | è°ƒæ•´ Autovacuum å‚æ•° |

---

## ğŸ“ æ—¥å¿—é…ç½®

### æ¨èé…ç½®

```ini
# postgresql.conf

# æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 1000  # è®°å½• > 1s çš„ SQL

# Checkpoint æ—¥å¿—
log_checkpoints = on

# è¿æ¥æ—¥å¿—
log_connections = on
log_disconnections = on

# æ—¥å¿—æ ¼å¼
log_line_prefix = '%m [%p] %u@%d '
log_statement = 'ddl'  # è®°å½•æ‰€æœ‰ DDL
```

### pgBadger æŠ¥å‘Š

```bash
# å®‰è£… pgBadger
brew install pgbadger  # macOS

# ç”Ÿæˆæ¯æ—¥æŠ¥å‘Š
pgbadger /var/log/postgresql/*.log -o /var/www/html/pgbadger.html
```

---

## ğŸ”— é‡‡é›†ä¸å‘Šè­¦é›†æˆ

### Prometheus + Grafana

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| `postgres_exporter` | PostgreSQL æŒ‡æ ‡é‡‡é›† |
| Prometheus | æŒ‡æ ‡å­˜å‚¨ä¸å‘Šè­¦è§„åˆ™ |
| Grafana | å¯è§†åŒ–ä»ªè¡¨æ¿ |

### postgres_exporter éƒ¨ç½²

```yaml
# docker-compose.yml
services:
  postgres_exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://monitor:password@postgres:5432/postgres?sslmode=disable"
    ports:
      - "9187:9187"
```

### Prometheus å‘Šè­¦è§„åˆ™

```yaml
# prometheus_rules.yml
groups:
  - name: postgresql
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          
      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          
      - alert: PostgreSQLTransactionIdWraparound
        expr: pg_database_age > 1500000000
        for: 0m
        labels:
          severity: critical
```

---

## AI å¼•ç”¨æŒ‡å—

å½“ AI é…ç½®æ•°æ®åº“ç›‘æ§æ—¶ï¼š
1. ä¼˜å…ˆç›‘æ§ Transaction ID Ageï¼ˆæœ€é«˜å±ï¼‰
2. å¯ç”¨ pg_stat_statements åˆ†ææ…¢æŸ¥è¯¢
3. é…ç½® Autovacuum å¥åº·å‘Šè­¦
4. ä½¿ç”¨ postgres_exporter + Prometheus
