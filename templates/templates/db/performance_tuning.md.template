# æ€§èƒ½è°ƒä¼˜æ¨¡æ¿ (Performance Tuning Template)

> **Metadata**
> - **Source**: `{{æ•°æ®åº“è®¾è®¡æ–‡æ¡£è·¯å¾„}}`
> - **Generated At**: `{{ç”Ÿæˆæ—¶é—´ YYYY-MM-DD HH:mm}}`
> - **Generator**: `Context-Agent v1.0`

---

## ğŸ–¥ï¸ åŸºç¡€è®¾æ–½å‰ç½®æ¡ä»¶

### å­˜å‚¨åˆ†ç¦»

| ç›®å½• | æ¨èå­˜å‚¨ | åŸå›  |
|------|---------|------|
| `pg_wal/` | ç‹¬ç«‹ NVMe SSD | WAL é¡ºåºå†™å…¥ï¼Œéœ€ä½å»¶è¿Ÿ |
| `base/` | é«˜æ€§èƒ½ SSD | æ•°æ®æ–‡ä»¶éšæœºè¯»å†™ |
| å¤‡ä»½ç›®å½• | å¯¹è±¡å­˜å‚¨ (S3) | æŒä¹…åŒ– + é˜²å‹’ç´¢ |

### æ–‡ä»¶ç³»ç»Ÿ

| é…ç½® | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| æ–‡ä»¶ç³»ç»Ÿç±»å‹ | **XFS** | æ¯” EXT4 æ›´å¥½çš„å¹¶å‘ I/O |
| æŒ‚è½½é€‰é¡¹ | `noatime,nodiratime` | ç¦ç”¨è®¿é—®æ—¶é—´æ›´æ–° |
| é¢„è¯» (Read-ahead) | 4KB - 8KB | OLTP éšæœºè®¿é—®ä¼˜åŒ– |

```bash
# è°ƒæ•´é¢„è¯»
blockdev --setra 16 /dev/sda  # 16 sectors = 8KB
```

### Huge Pages

> **> 64GB å†…å­˜æœåŠ¡å™¨å¿…é¡»å¯ç”¨**ï¼Œå‡å°‘ TLB å‹åŠ›ã€‚

```bash
# è®¡ç®—æ‰€éœ€ Huge Pages æ•°é‡
shared_buffers_mb=16384  # 16GB
huge_page_size_mb=2
nr_hugepages=$((shared_buffers_mb / huge_page_size_mb + 10))

# é…ç½® sysctl
echo "vm.nr_hugepages = $nr_hugepages" >> /etc/sysctl.conf
sysctl -p
```

### CPU / NUMA

| é…ç½® | å»ºè®® |
|------|------|
| NUMA ç­–ç•¥ | `numactl --interleave=all` æˆ–ç»‘å®šå•èŠ‚ç‚¹ |
| CPU è°ƒåº¦å™¨ | `performance` æ¨¡å¼ |

---

## ğŸ’¾ å†…å­˜é…ç½®

### æ ¸å¿ƒå‚æ•°

| å‚æ•° | å»ºè®®å€¼ | è¯´æ˜ |
|------|--------|------|
| `shared_buffers` | RAM çš„ 25%-40% | PostgreSQL æ•°æ®ç¼“å­˜ |
| `effective_cache_size` | RAM çš„ 50%-75% | ä¾›ä¼˜åŒ–å™¨ä¼°ç®—å¯ç”¨ç¼“å­˜ |
| `work_mem` | 16MB - 64MB | æ¯æ“ä½œæ’åº/Hash å†…å­˜ |
| `maintenance_work_mem` | 1GB - 4GB | VACUUM/CREATE INDEX å†…å­˜ |
| `huge_pages` | `on` | å‡å°‘ TLB å‹åŠ›ï¼ˆå¤§å†…å­˜æœåŠ¡å™¨ï¼‰ |

### é…ç½®ç¤ºä¾‹ï¼ˆ64GB RAM æœåŠ¡å™¨ï¼‰

```ini
# postgresql.conf
shared_buffers = 16GB
effective_cache_size = 48GB
work_mem = 64MB
maintenance_work_mem = 2GB
huge_pages = on
```

### work_mem é™·é˜±

> âš ï¸ `work_mem` æ˜¯**æ¯æ“ä½œçº§åˆ«**ï¼Œå¤æ‚æŸ¥è¯¢å¯èƒ½åŒæ—¶ä½¿ç”¨å¤šä¸ªã€‚  
> é«˜å¹¶å‘æ—¶æ…ç”¨é«˜å€¼ï¼Œé¿å… OOMã€‚  
> å¯¹æŠ¥è¡¨æŸ¥è¯¢å¯åœ¨ Session çº§åˆ«ä¸´æ—¶è°ƒå¤§ï¼š`SET work_mem = '1GB';`

---

## ğŸ“ WAL ä¸ Checkpoint

### ç›®æ ‡ï¼šå¹³æ»‘ I/O å³°å€¼

| å‚æ•° | å»ºè®®å€¼ | è¯´æ˜ |
|------|--------|------|
| `checkpoint_timeout` | 15-30 min | Checkpoint æ—¶é—´é—´éš” |
| `max_wal_size` | 4GB - 16GB | è§¦å‘ Checkpoint çš„ WAL ä¸Šé™ |
| `checkpoint_completion_target` | 0.9 | åœ¨é—´éš” 90% æ—¶é—´å†…å‡åŒ€åˆ·ç›˜ |
| `wal_compression` | `on` | å‡å°‘ WAL ä½“ç§¯ |

### é…ç½®ç¤ºä¾‹

```ini
checkpoint_timeout = 15min
max_wal_size = 8GB
checkpoint_completion_target = 0.9
wal_compression = on
```

---

## ğŸ§¹ Autovacuum è°ƒä¼˜

### é»˜è®¤é…ç½®è¿‡äºä¿å®ˆï¼

| å‚æ•° | é»˜è®¤å€¼ | ç”Ÿäº§å»ºè®® | è¯´æ˜ |
|------|--------|---------|------|
| `autovacuum_vacuum_scale_factor` | 0.2 (20%) | **0.02-0.05** | è§¦å‘é˜ˆå€¼ |
| `autovacuum_vacuum_cost_limit` | 200 | **1000-2000** | æ‰§è¡Œèƒ½åŠ› |
| `autovacuum_vacuum_cost_delay` | 2ms | 2ms | ä¼‘çœ é—´éš” |
| `autovacuum_max_workers` | 3 | 4-6 | å¹¶è¡Œ Worker æ•° |

### é…ç½®ç¤ºä¾‹

```ini
autovacuum_vacuum_scale_factor = 0.02
autovacuum_vacuum_cost_limit = 1500
autovacuum_max_workers = 4
```

### ç›‘æ§ Vacuum çŠ¶æ€

```sql
-- æ£€æŸ¥éœ€è¦ Vacuum çš„è¡¨
SELECT schemaname, relname, n_dead_tup, last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC;

-- æ£€æŸ¥äº‹åŠ¡ ID å›å·é£é™©ï¼ˆ> 15 äº¿éœ€ç«‹å³å¤„ç†ï¼‰
SELECT datname, age(datfrozenxid) AS xid_age
FROM pg_database
ORDER BY xid_age DESC;
```

---

## ğŸ”Œ è¿æ¥æ± é…ç½®

### PgBouncer æ¨èé…ç½®

| å‚æ•° | å»ºè®®å€¼ | è¯´æ˜ |
|------|--------|------|
| `pool_mode` | **transaction** | äº‹åŠ¡çº§å¤ç”¨ï¼ˆæ¨èï¼‰ |
| `max_client_conn` | 10000+ | åº”ç”¨å±‚æœ€å¤§è¿æ¥ |
| `default_pool_size` | 20-50 | æ¯æ•°æ®åº“è¿æ¥æ± å¤§å° |

### PostgreSQL è¿æ¥æ•°

```ini
# ä¿å®ˆè®¾ç½®ï¼Œè®© PgBouncer å¤„ç†æ’é˜Ÿ
max_connections = 300-500
```

### è¿æ¥æ•°å…¬å¼

```
æœ€ä½³æ´»åŠ¨è¿æ¥æ•° â‰ˆ CPU æ ¸å¿ƒæ•° Ã— 2 + ç£ç›˜è½´æ•°
```

### éƒ¨ç½²æ¨¡å¼

| æ¨¡å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **Sidecar** (Pod å†…) | ä½å»¶è¿Ÿ | è¿æ¥æ•°éšèŠ‚ç‚¹æ‰©å®¹ |
| **é›†ä¸­å¼** | ç»Ÿä¸€ç®¡æ§ | é¢å¤–ç½‘ç»œè·³æ•° |

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®å‘Šè­¦é˜ˆå€¼

| ç»´åº¦ | æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | å«ä¹‰ |
|------|------|---------|------|
| **å¯ç”¨æ€§** | PostgreSQL Up/Down | çŠ¶æ€å˜åŒ– | æ•°æ®åº“å­˜æ´» |
| **æ€§èƒ½** | Active Connections | > 80% max_conn | è¿æ¥æ± å³å°†æ‰“æ»¡ |
| **æ€§èƒ½** | Lock Wait Time | > 5s | é”äº‰ç”¨/æ­»é” |
| **å¤åˆ¶** | Replication Lag | > 100MB æˆ– > 10s | ä»åº“å»¶è¿Ÿ |
| **é£é™©** | Transaction ID Age | > 15 äº¿ | **æœ€é«˜å±**ï¼šéœ€ç«‹å³ Vacuum |
| **å­˜å‚¨** | Disk Usage | > 85% | ç£ç›˜ç©ºé—´ä¸è¶³ |

### pg_stat_statements é…ç½®

```ini
# postgresql.conf
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000
```

### æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- æ€»è€—æ—¶ Top 10
SELECT 
    substring(query, 1, 100) AS query,
    calls,
    round(total_exec_time::numeric, 2) AS total_ms,
    round(mean_exec_time::numeric, 2) AS mean_ms
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

### æ—¥å¿—é…ç½®

```ini
log_min_duration_statement = 1000  -- è®°å½• > 1s çš„ SQL
log_checkpoints = on
log_connections = on
log_disconnections = on
```

---

## AI å¼•ç”¨æŒ‡å—

å½“ AI ç”Ÿæˆæ•°æ®åº“é…ç½®æ—¶ï¼š
1. æ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´ shared_buffers
2. æ¿€è¿›é…ç½® Autovacuum é¿å…è¡¨è†¨èƒ€
3. ä½¿ç”¨è¿æ¥æ± ï¼Œå‹¿ç›´è¿æ•°æ®åº“
4. å¯ç”¨ pg_stat_statements ç›‘æ§
